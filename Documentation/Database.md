# Database

## Local Database Overview

### Room Library
Our app uses an SQLite database to provide local persistent storage. We are using [The Room Persistence Library](https://developer.android.com/training/data-storage/room), which provides an abstraction layer over SQLite. Room provides the following benefits:
* Compile-time verification of SQL queries
* Convenience annotations that minimize repetitive and error-prone boilerplate code
* Streamlined database migration paths

### Setup
Room is added to the `build.gradle` file, and is automatically added to the project at the next *Gradle Sync*.  
```java
// Room dependency used for SQLite database
    def room_version = "2.3.0"
    implementation "androidx.room:room-runtime:$room_version"
    annotationProcessor "androidx.room:room-compiler:$room_version"
    androidTestImplementation "androidx.room:room-testing:$room_version"
```

### Components
There are four main components in our Room database:
* The database class (`WeatherReportDatabase.java`)  
This class holds the database, and serves as the main access point for the underlying connection to our app's data. We are following the Singleton Design Pattern when instantiating a `WeatherReportDatabase` object.
* The Data Entity class (`WeatherReportModel.java`)  
This class represents the table in our app's database. Rather than creating a new class who's only purpose was to act as a Data Entity Class, we were able to use the existing `WeatherReportModel` class by just adding the correct Room annotations to it.
* The Data Access Object (DAO) (`WeatherReportDao.java`)  
This object provides methods that our app can use to query, update, insert and delete data in our database.
* The ViewModel (`WeatherReportViewModel.java`)  
This class is responsible for preparing and managing the database data for the activity that wants the database data.

### Usage
First, a `WeatherReportViewModel` object is created to manage the data between the database and the activity:
```java
// This is called inside whichever activity wants to access the database
WeatherReportViewModel viewModel;
viewModel = new ViewModelProvider(this).get(WeatherReportViewModel.class);
```
Inside the `WeatherReportViewModel` code, an instance of the database and the DAO are created:
```java
weatherDB = WeatherReportDatabase.getDatabase(application); 
weatherReportDao = weatherDB.weatherReportDao(); 
```

This hides away the complexities of interacting with the SQLite database behind a layer of abstraction, and the `ViewModel` handles the data:
```java
// Inserting a new weather report into the database
viewModel.insert(someWeatherReportModel);

// Getting all entries in the database in a list
viewModel.getAllWeatherReports();
```

### Notes
Our app uses data received from [metaweather.com](https://www.metaweather.com). This data is received as a JSON object, containing the various weather report properties. These properties are used to construct a `WeatherReportModel` object.  
One of the properties provided is an `id` number, which is used to identify each weather report on the [metaweather.com](https://www.metaweather.com) servers (as there are hundreds of thousands of unique weather reports available). We have chosen not to use this `id` number as the primary key in our database.  
Instead, when a `WeatherReportModel` is added to the database, a new `id` number is assigned to it, and this new `id` number is auto-generated by our app. This ensures that entries to the database have consecutive `id` numbers, in the order they were added. This makes identifying and accessing entries a relatively straightforward task.  

**Important** - the original id number provided by [metaweather.com](https://www.metaweather.com) is still stored alongside the new, auto-generated `id` number:
```java
@PrimaryKey(autoGenerate = true)
@NonNull
long id; // auto-generated ID number for the database
@NonNull
long trueID; // original ID number provided in the JSON object
```
The original `id` number is still used to help differentiate different database entries for the same location on the same day*. 

**This is subject to change as our database code evolves*